---
title: "Growth Curves"
author: "Jay T. Lennon"
date: "`r format(Sys.time(), '%d %B, %Y')`"
header-includes:
  - \usepackage{array}
output: pdf_document
geometry: margin=2.54cm
editor_options: 
  chunk_output_type: console
---

## Clear workspace and set directory
```{r setup}
rm(list=ls())
#setwd("~/Github/SporeMut/code/4.GrowthCurves/test")
setwd("~/Github/SporMut/code/4.GrowthCurves/test")
```

## Load packages and functions
```{r}
require("png")
require("dplyr")
require("grid")
require("gtools")
require("nlme")
require("MuMIn")
require("bbmle")
#source("~/Github/SporeMut/code/4.GrowthCurves/bin/modified_Gomp_diagnostic3.R")
source("~/Github/SporMut/code/4.GrowthCurves/bin/modified_Gomp_diagnostic3.R")
sem <- function(x) sqrt(var(x)/length(x))
cv <- function(x) 100*( sd(x)/mean(x))
LL.95 <- function(x) t.test(x)$conf.int[1]
UL.95 <- function(x) t.test(x)$conf.int[2]

# Update - Canan
require(tidyverse) #ggplot,dplyr, dependencies  
require(ggh4x) #ggplot tricks
require(scales) #ggplot scaling axes
require(lme4) #linear mixed effect models
require(emmeans) #marginal means
require(multcomp) #multiple comparisons
require(multcompView) #multiple comparisons
require(optimx) #optimizer for lmer
require(afex) #for p values
require(jtools) #plot model results
require(patchwork) #to combine plots 

# For Bayesian stats 
require("rstan")
require("devtools")
install_github("paul-buerkner/brms")
library(brms)
devtools::install_github("strengejacke/sjstats")
library(bayestestR)
library(bayesplot) #plotting posteriors
```

## Load data
```{r}
# Load data and change time to numeric
# dat <- read.csv("~/Github/SporeMut/code/4.GrowthCurves/data/batch_combo.csv")
# dat <- cbind(dat1,dat2)
# anc <-read.csv("~/Github/SporeMut/code/4.GrowthCurves/data/ancestor.csv")
# anc$Time <- as.numeric(sub("^(\\d+):(\\d+).*", "\\1.\\2", anc$Time))
# dat <- read.csv("~/Github/SporeMut/code/4.GrowthCurves/data/20230802_GrowthCurve_SporeMut.csv")

#dat <- read.csv("~/Github/SporeMut/code/4.GrowthCurves/data/20230821_GrowthCurve_SporeMut.csv")
dat  <- read.csv("~/Github/SporMut/code/4.GrowthCurves/data/20230821_GrowthCurves_SporeMut.csv")
dat2 <- read.csv("~/Github/SporMut/code/4.GrowthCurves/data/20230822_SporeMut_GrowthCurves_R2B.csv")
dat3 <- read.csv("~/Github/SporMut/code/4.GrowthCurves/data/20230823_SporeMut_GrowthCurves_R2B.csv")
dat4 <- read.csv("~/Github/SporMut/code/4.GrowthCurves/data/20230824_SporeMut_GrowthCurves_R2B.csv")
dat5 <- read.csv("~/Github/SporMut/code/4.GrowthCurves/data/20230826_SporeMut_GrowthCurves_R2B.csv")

dat$Time <- as.numeric(sub("^(\\d+):(\\d+).*", "\\1.\\2", dat$Time))
# filter so length of data is equal across strains
#dat <- dat.raw %>% 
# filter(row_number() <= 93) 

dat2$Time <- as.numeric(sub("^(\\d+):(\\d+).*", "\\1.\\2", dat2$Time))
dat3$Time <- as.numeric(sub("^(\\d+):(\\d+).*", "\\1.\\2", dat3$Time))
dat4$Time <- as.numeric(sub("^(\\d+):(\\d+).*", "\\1.\\2", dat4$Time))
dat5$Time <- as.numeric(sub("^(\\d+):(\\d+).*", "\\1.\\2", dat5$Time))
```
## Run Gompertz model - Do not run if you already have the outputs - Read outputs
```{r}
# Slow process: comment out line below after running
# Here, read in each strain one-at-a-time (helps with troubleshooting fits)

anc <- dat %>%
  dplyr::select(Time, starts_with("ancestor"))
anc.fits <-growth.modGomp(input = anc, output.name = "anc_new.fit.parms",
        synergy = F, temp = F, smooth = T, trim = T)

M4 <- dat %>%
  dplyr::select(Time, starts_with("M4_"))
M4.fits <-growth.modGomp(input = M4, output.name = "M4_new.fit.parms",
        synergy = F, temp = F, smooth = T, trim = T)

S1 <- dat %>%
  dplyr::select(Time, starts_with("S1_"))
S1.fits <-growth.modGomp(input = S1, output.name = "S1_new.fit.parms",
        synergy = F, temp = F, smooth = T, trim = T)
S1.fits.out <- read.table("../output/S1_new.fit.parms.txt", sep = ",", header = TRUE)

M23 <- dat %>%
  dplyr::select(Time, starts_with("M23_"))
M23.fits <-growth.modGomp(input = M23, output.name = "M23_new.fit.parms",
        synergy = F, temp = F, smooth = T, trim = T)

M13 <- dat2 %>%
  dplyr::select(Time, starts_with("M13_"))
M13.fits <-growth.modGomp(input = M13, output.name = "M13_new.fit.parms",
        synergy = F, temp = F, smooth = T, trim = T)

M17 <- dat2 %>%
  dplyr::select(Time, starts_with("M17_"))
M17.fits <-growth.modGomp(input = M17, output.name = "M17_new.fit.parms",
        synergy = F, temp = F, smooth = T, trim = T)

M19 <- dat2 %>%
  dplyr::select(Time, starts_with("M19_"))
M19.fits <-growth.modGomp(input = M19, output.name = "M19_new.fit.parms",
        synergy = F, temp = F, smooth = T, trim = T)
M19.fits.out <- read.table("../output/M19_new.fit.parms.txt", sep = ",", header = TRUE)

M21 <- dat2 %>%
  dplyr::select(Time, starts_with("M21_"))
M21.fits <-growth.modGomp(input = M21, output.name = "M21_new.fit.parms",
        synergy = F, temp = F, smooth = T, trim = T)

M26 <- dat2 %>%
  dplyr::select(Time, starts_with("M26_"))
M26.fits <-growth.modGomp(input = M26, output.name = "M26_new.fit.parms",
        synergy = F, temp = F, smooth = T, trim = T)

M41 <- dat2 %>%
  dplyr::select(Time, starts_with("M41_"))
M41.fits <-growth.modGomp(input = M41, output.name = "M41_new.fit.parms",
        synergy = F, temp = F, smooth = T, trim = T)

M54 <- dat2 %>%
  dplyr::select(Time, starts_with("M54_"))
M41.fits <-growth.modGomp(input = M54, output.name = "M54_new.fit.parms",
        synergy = F, temp = F, smooth = T, trim = T)

M79 <- dat2 %>%
  dplyr::select(Time, starts_with("M79_"))
M79.fits <-growth.modGomp(input = M79, output.name = "M79_new.fit.parms",
        synergy = F, temp = F, smooth = T, trim = T)

S6 <- dat2 %>%
  dplyr::select(Time, starts_with("S6_"))
S6.fits <-growth.modGomp(input = S6, output.name = "S6_new.fit.parms",
        synergy = F, temp = F, smooth = T, trim = T)
S6.fits.out <- read.table("../output/S6_new.fit.parms.txt", sep = ",", header = TRUE)

S11 <- dat2 %>%
  dplyr::select(Time, starts_with("S11_"))
S11.fits <-growth.modGomp(input = S11, output.name = "S11_new.fit.parms",
        synergy = F, temp = F, smooth = T, trim = T)

S22 <- dat3 %>%
  dplyr::select(Time, starts_with("S22_"))
S22.fits <-growth.modGomp(input = S22, output.name = "S22_new.fit.parms",
        synergy = F, temp = F, smooth = T, trim = T)

S51 <- dat3 %>%
  dplyr::select(Time, starts_with("S51_"))
S51.fits <-growth.modGomp(input = S51, output.name = "S51_new.fit.parms",
        synergy = F, temp = F, smooth = T, trim = T)

S95 <- dat3 %>%
  dplyr::select(Time, starts_with("S95_"))
S95.fits <-growth.modGomp(input = S95, output.name = "S95_new.fit.parms",
        synergy = F, temp = F, smooth = T, trim = T)

#fits.anc <- growth.modGomp(input = anc, output.name = "fit.anc.parms",
#        synergy = F, temp = F, smooth = T, trim = T)
#fits.anc.out <- read.table("../output/fit.anc.parms.txt", sep = ",", header = TRUE)
#treat.anc <- read.csv("../data/treatments.anc.csv")
#anc.parms <- data.frame(treat.anc, fits.anc.out)
```

## Read outputs
```{r}
M4.fits.out  <- read.table("../output/M4_new.fit.parms.txt", sep = ",", header = TRUE)
anc.fits.out <- read.table("../output/anc_new.fit.parms.txt", sep = ",", header = TRUE)
M23.fits.out <- read.table("../output/M23_new.fit.parms.txt", sep = ",", header = TRUE)
M13.fits.out <- read.table("../output/M13_new.fit.parms.txt", sep = ",", header = TRUE)
M17.fits.out <- read.table("../output/M17_new.fit.parms.txt", sep = ",", header = TRUE)
M19.fits.out <- read.table("../output/M19_new.fit.parms.txt", sep = ",", header = TRUE)
M21.fits.out <- read.table("../output/M21_new.fit.parms.txt", sep = ",", header = TRUE)
M26.fits.out <- read.table("../output/M26_new.fit.parms.txt", sep = ",", header = TRUE)
M54.fits.out <- read.table("../output/M54_new.fit.parms.txt", sep = ",", header = TRUE)
M41.fits.out <- read.table("../output/M41_new.fit.parms.txt", sep = ",", header = TRUE)
M79.fits.out <- read.table("../output/M79_new.fit.parms.txt", sep = ",", header = TRUE)
S1.fits.out  <- read.table("../output/S1_new.fit.parms.txt", sep = ",", header = TRUE)
S6.fits.out  <- read.table("../output/S1_new.fit.parms.txt", sep = ",", header = TRUE)
S11.fits.out <- read.table("../output/S11_new.fit.parms.txt", sep = ",", header = TRUE)
S22.fits.out <- read.table("../output/S22_new.fit.parms.txt", sep = ",", header = TRUE)
S51.fits.out <- read.table("../output/S51_new.fit.parms.txt", sep = ",", header = TRUE)
S95.fits.out <- read.table("../output/S95_new.fit.parms.txt", sep = ",", header = TRUE)
```

## Repeated growth curves- Do not run if you already have the outputs - Read outputs 
```{r}
# Repeated growth curves 
M13.R <- dat4 %>%
  dplyr::select(Time, starts_with("M13_"))
M13.R.fits <-growth.modGomp(input = M13.R, output.name = "M13_repeat.new.fit.parms",
        synergy = F, temp = F, smooth = T, trim = T)

M17.R <- dat4 %>%
  dplyr::select(Time, starts_with("M17_"))
M17.R.fits <-growth.modGomp(input = M17.R, output.name = "M17_repeat.new.fit.parms",
        synergy = F, temp = F, smooth = T, trim = T)

M21.R <- dat4 %>%
  dplyr::select(Time, starts_with("M21_"))
M21.R.fits <-growth.modGomp(input = M21.R, output.name = "M21_repeat.new.fit.parms",
        synergy = F, temp = F, smooth = T, trim = T)

M23.R <- dat4 %>%
  dplyr::select(Time, starts_with("M23_"))
M23.R.fits <-growth.modGomp(input = M23.R, output.name = "M23_repeat.new.fit.parms",
        synergy = F, temp = F, smooth = T, trim = T)

M54.R <- dat4 %>%
  dplyr::select(Time, starts_with("M54_"))
M54.R.fits <-growth.modGomp(input = M54.R, output.name = "M54_repeat.new.fit.parms",
        synergy = F, temp = F, smooth = T, trim = T)

S1.R <- dat4 %>%
  dplyr::select(Time, starts_with("S1_"))
S1.R.fits <-growth.modGomp(input = S1.R, output.name = "S1_repeat.new.fit.parms",
        synergy = F, temp = F, smooth = T, trim = T)

S11.R <- dat4 %>%
  dplyr::select(Time, starts_with("S11_"))
S11.R.fits <-growth.modGomp(input = S11.R, output.name = "S11_repeat.new.fit.parms",
        synergy = F, temp = F, smooth = T, trim = T)

S22.R <- dat4 %>%
  dplyr::select(Time, starts_with("S22_"))
S22.R.fits <-growth.modGomp(input = S22.R, output.name = "S22_repeat.new.fit.parms",
        synergy = F, temp = F, smooth = T, trim = T)

S51.R <- dat4 %>%
  dplyr::select(Time, starts_with("S51_"))
S51.R.fits <-growth.modGomp(input = S51.R, output.name = "S51_repeat.new.fit.parms",
        synergy = F, temp = F, smooth = T, trim = T)

S95.R <- dat4 %>%
  dplyr::select(Time, starts_with("S95_"))
S95.R.fits <-growth.modGomp(input = S95.R, output.name = "S95_repeat.new.fit.parms",
        synergy = F, temp = F, smooth = T, trim = T)

M4.R <- dat5 %>%
  dplyr::select(Time, starts_with("M4_"))
M4.R.fits <-growth.modGomp(input = M4.R, output.name = "M4_repeat.new.fit.parms",
        synergy = F, temp = F, smooth = T, trim = T)

M19.R <- dat5 %>%
  dplyr::select(Time, starts_with("M19_"))
M19.R.fits <-growth.modGomp(input = M19.R, output.name = "M19_repeat.new.fit.parms",
        synergy = F, temp = F, smooth = T, trim = T)

M23.R2 <- dat5 %>%
  dplyr::select(Time, starts_with("M23_"))
M23.R2.fits <-growth.modGomp(input = M23.R2, output.name = "M23_repeat2.new.fit.parms",
        synergy = F, temp = F, smooth = T, trim = T)

M26.R <- dat5 %>%
  dplyr::select(Time, starts_with("M26_"))
M26.R.fits <-growth.modGomp(input = M26.R, output.name = "M26_repeat.new.fit.parms",
        synergy = F, temp = F, smooth = T, trim = T)

M41.R <- dat5 %>%
  dplyr::select(Time, starts_with("M41_"))
M41.R.fits <-growth.modGomp(input = M41.R, output.name = "M41_repeat.new.fit.parms",
        synergy = F, temp = F, smooth = T, trim = T)
```

## Read repeated outputs 
```{r}
M13.R.fits.out  <- read.table("../output/M13_repeat.new.fit.parms.txt", sep = ",", header = TRUE)
M17.R.fits.out  <- read.table("../output/M17_repeat.new.fit.parms.txt", sep = ",", header = TRUE)
M21.R.fits.out  <- read.table("../output/M21_repeat.new.fit.parms.txt", sep = ",", header = TRUE)
M23.R.fits.out  <- read.table("../output/M23_repeat.new.fit.parms.txt", sep = ",", header = TRUE)
M54.R.fits.out  <- read.table("../output/M54_repeat.new.fit.parms.txt", sep = ",", header = TRUE)
S1.R.fits.out   <- read.table("../output/S1_repeat.new.fit.parms.txt", sep = ",", header = TRUE)
S11.R.fits.out  <- read.table("../output/S11_repeat.new.fit.parms.txt", sep = ",", header = TRUE)
S22.R.fits.out  <- read.table("../output/S22_repeat.new.fit.parms.txt", sep = ",", header = TRUE)
S51.R.fits.out  <- read.table("../output/S51_repeat.new.fit.parms.txt", sep = ",", header = TRUE)
S95.R.fits.out  <- read.table("../output/S95_repeat.new.fit.parms.txt", sep = ",", header = TRUE)
M4.R.fits.out   <- read.table("../output/M4_repeat.new.fit.parms.txt", sep = ",", header = TRUE)
M19.R.fits.out  <- read.table("../output/M19_repeat.new.fit.parms.txt", sep = ",", header = TRUE)
M23.R2.fits.out <- read.table("../output/M23_repeat2.new.fit.parms.txt", sep = ",", header = TRUE)
M26.R.fits.out  <- read.table("../output/M26_repeat.new.fit.parms.txt", sep = ",", header = TRUE)
M41.R.fits.out  <- read.table("../output/M41_repeat.new.fit.parms.txt", sep = ",", header = TRUE)
```

## Subset the best 6 curves of each clone based on RMSE
```{r}
# Subset the best 6 curves of each clone 
# Removing non fitting models and and selecting 6 of them 
# where RMSE smaller.

# anc.fits.out
M4_all  <- rbind.data.frame(M4.fits.out, M4.R.fits.out)
M13_all <- rbind.data.frame(M13.fits.out[-c(1,6),], M13.R.fits.out)
M17_all <- rbind.data.frame(M17.fits.out[-1,], M17.R.fits.out[-c(2,5,6),])
M19_all <- rbind.data.frame(M19.fits.out, M19.R.fits.out[-c(2,10),])
M21_all <- rbind.data.frame(M21.fits.out[-c(2,6),], M21.R.fits.out)
M23_all <- rbind.data.frame(M23.R.fits.out, M23.R2.fits.out)
M26_all <- rbind.data.frame(M26.fits.out, M26.R.fits.out[-1,])
#M41.fits.out
M54_all <- rbind.data.frame(M54.fits.out[-3,], M54.R.fits.out[-c(2,4),])
#M79.fits.out
S1_all  <- rbind.data.frame(S1.fits.out[-5,], S1.R.fits.out)
#S6.fits.out
S11_all <- rbind.data.frame(S11.fits.out, S11.R.fits.out)
S22_all <- rbind.data.frame(S22.fits.out[-c(3,4),], S22.R.fits.out)
S51_all <- rbind.data.frame(S51.fits.out, S51.R.fits.out)
S95_all <- rbind.data.frame(S95.fits.out, S95.R.fits.out)

#choose rhe first 6 lowest RSME

dflist <- list(anc.fits.out, M4_all, M13_all, M17_all, M19_all, M21_all,
            M23_all, M26_all, M41.fits.out, M54_all,
            M79.fits.out, S1_all,S6.fits.out, S11_all, 
            S22_all, S51_all, S95_all)

bestCurve <- function(x){
  x[x$RSME %in% sort(x$RSME, partial = 1:6)[1:6], ] 
}

dflist_best <- lapply(dflist, bestCurve)

# M13.reps <- M13_all$umax[abs(M13_all$umax-median(M13_all$umax)) %in% sort(abs(M13_all$umax-median(M13_all$umax)), partial=1:6)[1:6]]
# M13.all.out <- M13_all[M13_all$umax %in% M13.reps, ]  

```

## Merge with treatment data - Fixed
```{r}
all.fits <- bind_rows(dflist_best, .id = "column_label")

all.fits$clones <- gsub("_.*","",all.fits$Curve)
all.fits$clones[1:6] <- rep("ancestor", time = 6)

# Combine fits with strain and treatment information (e.g, cell type, mutations, etc.)
treats <- read.csv("~/Github/SporMut/code/4.GrowthCurves/data/treatments_original_corrected.csv")

# The correct file is treatments_original.csv, I added ancestor and changed some factor level names and
# saved as treatments_original_corrected.csv
#parms <- data.frame(treats, all.fits) 
# this doesn't work, probably because some of the fits didn't converge?
# It is because some clones have different amount of reps 
# Also it is the wrong file.  
# Another thing I'd avoid cbind. Safest way is binding with ID column

all.fits.treats <- all.fits %>%
  left_join(treats, by = "clones")
```

## Wrangle dplyr/ggplot version - Canan
```{r}
# column
# filter spores
treats_param <-  all.fits.treats %>%
  filter(!evo.type == "spore") %>%
mutate(clone = tolower(clones)) %>%
  mutate (mutation = recode(mutation, nomut = 'ancestor', spormut = 'spore'))
write.csv(treats_param, "growthData")

# summarize 
sum_treats_param <-  treats_param %>%
      group_by(clone, evo.type, cell.type, mutation) %>%
      summarize(mean_A = mean(A), mean_umax = mean(umax), 
            mean_L = mean(L), sem_A = sem(A), sem_umax = sem(umax), 
            sem_L = sem(L), LL.95_A = LL.95(A), LL.95_umax = LL.95(umax), 
            LL.95_L = LL.95(L), UL.95_A = UL.95(A), UL.95_umax = UL.95(umax), 
            UL.95_L = UL.95(L)) %>%
            ungroup()

# order factor levels
sum_treats_param$clone <- factor(sum_treats_param$clone, levels = c("ancestor", "m23","m26","m17", "m19", "m21", "m41", "m54", "m4", "m13", "m79")) 

treats_param$clone <- factor(treats_param$clone, levels = c("ancestor", "m23","m26","m17", "m19", "m21", "m41", "m54", "m4", "m13", "m79")) 

ggplot(sum_treats_param, aes(x = weave_factors(clone, mutation, evo.type, cell.type), y = mean_umax, group = interaction(clone, mutation)))+
  geom_point(shape = 1, size = 4, color = "black", position = position_dodge(0.5))+
  geom_point(data = treats_param, aes(x = weave_factors(clone, mutation, evo.type, cell.type), y = umax, group = interaction(clone, mutation)), position = position_dodge(0.5), alpha = .3, size = 4, color = "grey")+
  geom_errorbar(data = sum_treats_param, aes (ymin = (mean_umax - sem_umax), ymax = (mean_umax + sem_umax),group = interaction(clone, mutation)), width = .2, color = "black", position = position_dodge(0.5))+
  ylab("Maximum growth rate")+
  #scale_x_discrete(limits = level_order)+
  #facet_wrap(~treatment, ncol = 4, scales = "free_x", drop = TRUE)+
  theme_bw()+
  theme(legend.position = 'bottom')+
  theme(axis.ticks.length=unit(.25, "cm"))+
  theme(legend.title = element_blank(), legend.text = element_text(size=12))+
  theme(axis.text = element_text(size = 14), 
  axis.title.x = element_blank(), axis.title.y = element_text(size =14))+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  force_panelsizes(cols = c(0.3, 0.6, 1.18, 0.9))+
  guides(x = "axis_nested")+
  scale_x_discrete(guide = guide_axis_nested(delim = "!"))+
  guides(x.sec = guide_axis_manual(
    breaks = ~., seq_len(nrow(sum_treats_param)), labels = NULL))+
      guides(y.sec = guide_axis_manual(
    breaks = c(0.15, 0.13, 0.11, 0.09, 0.07), labels = NULL))
```
## Relative fitness - Canan -after Don
```{r}
treats_param$clone <- factor(treats_param$clone, levels = c("ancestor", "m4", "m13", "m79", "m17", "m19", "m21",  "m41", "m54", "m23","m26"))  
sum_treats_param$clone <- factor(sum_treats_param$clone, levels = c("ancestor", "m4", "m13", "m79", "m17", "m19", "m21",  "m41", "m54", "m23","m26")) 

# Plot to compare with other analysis
ggplot(sum_treats_param, aes(y = clone, x = mean_umax))+
  geom_point(shape = 1, size = 4, color = "black")+
  geom_point(data = treats_param, aes(x = umax, y = clone), alpha = .3, size = 4, color = "grey")+
  geom_errorbar(data = sum_treats_param, aes (y = clone, xmin = (mean_umax - sem_umax), xmax = (mean_umax + sem_umax)), width = .2, color = "black")+
  ggtitle("Maximum growth rate - mean/se")+
  theme_bw()+
  theme(axis.ticks.length=unit(.25, "cm"))+
  theme(legend.title = element_blank(), legend.text = element_text(size=12))+
  theme(axis.text = element_text(size = 14), 
  axis.title.x = element_blank(), axis.title.y = element_text(size =14))+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

# relative growth rate - from Don 

w_anc <- (1/treats_param$clones[['ancestor']]$umax.se^2)/sum((1/treats_param[['ancestor']]$umax.se^2))
anc_mean <- sum(w_anc*treats_param[['anc']]$umax)
anc_var  <- sum(w_anc*(treats_param[['anc']]$umax-anc_mean)^2)/(1-sum(w_anc^2))

treats_param_anc <- treats_param %>%
  filter(clone == "ancestor") %>% 
reframe(w_anc = (1/umax.se^2)/sum((1/umax.se^2)), 
         mean_anc = sum(w_anc*umax), 
         var_anc = sum(w_anc*(umax-mean_anc)^2)/(1-sum(w_anc^2)))

w_anc    <- treats_param_anc$w_anc
mean_anc <- treats_param_anc$mean_anc
var_anc  <- treats_param_anc$var_anc

treats_param_rel <- treats_param %>% 
  group_by(clone) %>% 
    filter(!clone == "ancestor") %>% 
  reframe(w_clones = (1/umax.se^2)/sum((1/umax.se^2)), 
         mean_clones = sum(w_clones*umax), 
         var_clones = sum(w_clones*(umax-mean_anc)^2)/(1-sum(w_anc^2))) %>%
  mutate(rf = mean_clones/mean_anc) %>%
mutate(rf_se = mean_clones/mean_anc*sqrt((sqrt(var_clones)/mean_clones)^2+(sqrt(var_anc)/mean_anc)^2), 
       lower = rf-1.96*rf_se, upper = rf+1.96*rf_se) %>%
dplyr::select(c('clone', 'rf', 'rf_se', 'lower', 'upper'))%>%
group_by(clone) %>%
  summarise(rf = mean(rf), rf_se = mean(rf_se), lower = mean(lower), upper = mean(upper))


ggplot(treats_param_rel, aes(y = clone, x = rf))+
  geom_vline(xintercept = 1, linetype = "dashed")+
  geom_point(shape = 1, size = 4, color = "black")+
  #geom_errorbar(aes (y = clone, xmin = (rf - rf_se), xmax = (rf + rf_se)), width = .2, color = "red")+
  geom_errorbar(aes (y = clone, xmin = lower, xmax = upper), width = .2, color = "black")+
  ggtitle("Relative fitness - mean/se")+
  theme_bw()+
  theme(axis.ticks.length=unit(.25, "cm"))+
  theme(legend.title = element_blank(), legend.text = element_text(size=12))+
  theme(axis.text = element_text(size = 14), 
  axis.title.x = element_blank(), axis.title.y = element_text(size =14))+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())


treats_param_rel <- treats_param %>% 
  group_by(clone) %>% 
    filter(!clone == "ancestor")  %>% 
  dplyr::select(clone, umax) %>% 
  mutate(rel = umax/anc_mean) %>% 
  group_by(clone) %>% 
  summarise(mean = mean(rel), se = sem(rel))


ggplot(treats_param_rel, aes(y = clone, x = mean))+
  geom_vline(xintercept = 1, linetype = "dashed")+
  geom_point(shape = 1, size = 4, color = "black")+
  geom_errorbar(aes (y = clone, xmin = mean - se, xmax = mean + se) , width = .2, color = "black")+
  ggtitle("Relative fitness - mean/se")+
  theme_bw()+
  theme(axis.ticks.length=unit(.25, "cm"))+
  theme(legend.title = element_blank(), legend.text = element_text(size=12))+
  theme(axis.text = element_text(size = 14), 
  axis.title.x = element_blank(), axis.title.y = element_text(size =14))+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

treats_param_rel_m <- treats_param %>% 
  group_by(clone) %>% 
    filter(!clone == "ancestor")  %>% 
  dplyr::select(clone, umax) %>% 
  mutate(rel = umax/anc_mean)


mumax <- brm(rel ~ 0 + clone, data = treats_param_rel_m,
          family = "gaussian")
posterior_summary(mumax)
posteriorumax <- as.array(mumax)

mcmc_intervals(posteriorumax, pars = pars,
  prob = 0.95, # 95% intervals
  prob_outer = 1)+
  geom_vline(xintercept = 1)
  #scale_y_discrete(labels = labels)+
  #scale_x_continuous(breaks = c(-0.05, 0.1, 0, 0.05, 0.1), labels = c(-1.05, 1.1, 1, 1.05, 1.1))+
  xlab("Relative fitness")+
  ggtitle("µmax-posterior distributions",
"medians and 95% credible intervals (CI)")+
theme
ggsave("umax-clones.pdf", umax1, height = 5, width = 5)

```

## Remake Megan's figure for the manuscript - Canan
```{r}
treats_param_long <- treats_param %>%
  dplyr::select(b0, A, umax, L, evo.type, cell.type, mutation, clone) %>%
  pivot_longer(cols = c(b0, A, umax, L), names_to = "parameter", values_to = "value") %>%
  mutate (mutation = recode(mutation, nomut = 'ancestor', spormut = 'spore'))

treats_param_se <- treats_param %>%
  dplyr::select(b0.se, A.se, umax.se, L.se, mutation) %>%
  pivot_longer(cols = c(b0.se, A.se, umax.se, L.se), names_to = "parameter", values_to = "value") %>%
  group_by(mutation, parameter) %>%
  summarise(meanerror = mean(value)) %>%
  mutate (mutation = recode(mutation, nomut = 'ancestor', spormut = 'spore'))

treats_param_sum <- treats_param_long %>%
  group_by(mutation, parameter, evo.type, cell.type) %>%
  summarise(meanvalue = mean(value)) %>%
  ungroup() %>% 
  bind_cols(meanerror = treats_param_se$meanerror) %>%
  mutate (mutation = recode(mutation, nomut = 'ancestor', spormut = 'spore'))


ggplot(treats_param_sum, aes(x = mutation, y = meanvalue, color = mutation))+
  geom_jitter(data = treats_param_long, aes(x = mutation, y = value), alpha = .3)+
  geom_point(aes(x = mutation, y = meanvalue), size = 5, shape = 1, stroke = 1)+
  facet_wrap(~parameter, scales = "free")+
  geom_errorbar(aes(ymin = (meanvalue - meanerror), 
                 ymax = (meanvalue + meanerror)), width = .2, linewidth = 0.8)+
  theme_bw()+
  theme(legend.position = 'bottom')+
  theme(axis.ticks.length=unit(.25, "cm"))+
  theme(legend.title = element_blank(), legend.text = element_text(size=12))+
  theme(axis.text = element_text(size = 14), 
  axis.title.x = element_blank(), axis.title.y = element_text(size = 14))+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  theme(axis.text.x = element_blank())+
  theme(strip.text.x = element_text(size = 14))+
  scale_color_manual(values = c("#E64B35","#4DBBD5","#3C5488","#F39B7F"))
  
``` 

## Stats - Canan - Mutation comparisons
```{r}
set.seed(1010350)

treats_param$mutation <- as.factor(treats_param$mutation)
contrasts(treats_param$mutation) <- contr.treatment(4, base = 1)  # Treat Control as the reference level
custom_contrasts <- matrix(c(0, 0, 0, 1, 0, 0,0, 1, 0, 0, 0, 1), nrow = 4, ncol = 3, byrow = T)

#Carrying capacity 
mod1 <- lmer(A ~ mutation + (1|clones) , data = treats_param, REML = F, 
          control = lmerControl(optimizer ='optimx', optCtrl = list(method='nlminb')), contrasts = list(mutation = custom_contrasts))
summary(mod1)

emm_mut1 <- emmeans(mod1, ~mutation)
c1 <- contrast(emm_mut1, "trt.vs.ctrl")

#Lag time
mod3 <- lmer(L ~ mutation + (1|clones) , data = treats_param, REML = F, 
          control = lmerControl(optimizer ='optimx', optCtrl=list(method='nlminb')), contrasts = list(mutation = custom_contrasts))
summary(mod3)

emm_mut3 <- emmeans(mod3, "mutation")
c3 <- contrast(emm_mut3, "trt.vs.ctrl")

#Max. growth rate
mod4 <- lmer(umax ~ mutation + (1|clones) , data = treats_param, REML = F, 
          control = lmerControl(optimizer ='optimx', optCtrl=list(method='nlminb')), contrasts = list(mutation = custom_contrasts))
summary(mod4)

emm_mut4 <- emmeans(mod4, "mutation")
c4 <- contrast(emm_mut4, "trt.vs.ctrl")


dataPlot <- rbind.data.frame(as.data.frame(emm_mut1),
                             as.data.frame(emm_mut3), 
                             as.data.frame(emm_mut4))
                             
dataPlot$parameter <- rep(c('K', 'lag', 'umax'), each = 4)

dataPlotN <- cbind.data.frame(mutation = dataPlot$mutation, mean = dataPlot$emmean, se = dataPlot$SE, parameter = dataPlot$parameter)

dataContrast <- rbind.data.frame(as.data.frame(c1),
                             as.data.frame(c3), 
                             as.data.frame(c4))

dataContrast$parameter <- rep(c('K', 'lag', 'umax'), each = 3)

contrastPlot <- cbind.data.frame(contrast = dataContrast$contrast, estimate = dataContrast$estimate, se = dataContrast$SE, p.value = dataContrast$p.value, 
                                 parameter = dataContrast$parameter)

treats_param_rel <- treats_param_long %>%
  filter(!parameter == "b0") %>%
   mutate(parameter = recode(parameter, A = "K", L = "lag"))
  
#Lag - ancestor-spore and ancestor-sinR significant 
ggplot(dataPlotN, aes(x = mutation, y = mean), color ="grey20")+
  geom_jitter(data = treats_param_rel, aes(x = mutation, y = value, color = clone, fill = clone), alpha = .5, shape = 21)+
  geom_point(aes(x = mutation, y = mean), size = 5, shape = 1, stroke = 1)+
  facet_wrap(~parameter, scales = "free")+
  geom_errorbar(aes(ymin = (mean - se), 
                 ymax = (mean + se)), width = .2, linewidth = 0.8)+
  theme_bw()+
  theme(legend.position = 'none')+
  theme(axis.ticks.length=unit(.25, "cm"))+
  theme(legend.title = element_blank(), legend.text = element_text(size=12))+
  theme(axis.text = element_text(size = 14), 
  axis.title.x = element_blank(), axis.title.y = element_text(size = 14))+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
   theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  theme(strip.text.x = element_text(size = 14))+
  scale_color_manual(values = c("#E64B35","#4DBBD5","#3C5488","#F39B7F", 
                                "#00A087", "#7E6148", "thistle3", 
                                "goldenrod1", "darkkhaki", "coral4", 
                                "skyblue4"))+
  scale_fill_manual(values = c("#E64B35","#4DBBD5","#3C5488","#F39B7F", 
                                "#00A087", "#7E6148", "thistle3", 
                                "goldenrod1", "darkkhaki", "coral4", 
                                "skyblue4"))+
   scale_y_continuous(labels = label_number(accuracy = 0.01))
```

## Stats - Canan - Clone comparisons 
```{r}
K <- lm(A ~ clone, data = treats_param)
summary(K)
emm_m1 <- emmeans(K, ~clone)
con1 <- contrast(emm_m1, "trt.vs.ctrl")

umax <- lm(umax ~ clone, data = treats_param)
summary(umax)
emm_m2 <- emmeans(umax, ~clone)
con2 <- contrast(emm_m2, "trt.vs.ctrl")

lag <- lm(L ~ clone, data = treats_param)
summary(lag)
emm_m3 <- emmeans(lag, ~clone)
con3 <- contrast(emm_m3, "trt.vs.ctrl")

plotK <- plot_summs(K, robust = T, plot.distributions = TRUE, colors = '#3C5488')+
  theme_bw()+
  theme(legend.position = 'none')+
  theme(axis.ticks.length = unit(.25, "cm"))+
  theme(legend.text = element_text(size=12))+
  theme(axis.text = element_text(size = 14), axis.title.y = element_text(size = 14), axis.title.x = element_text(size = 14))+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  theme(strip.text.x = element_text(size = 14))+
  scale_y_discrete(labels = c('m79','m54','m41','m26','m23','m21','m19','m17','m13','m4'))+
  ylab("Clone ID")+
  scale_x_continuous(breaks = c(-0.10,-0.05, 0, 0.05, 0.10), labels = c(-1.10,-1.05, 1, 1.05, 1.10))+
  xlab("Relative change")+
  ggtitle("K")+
  scale_color_manual(values = "grey25")
  
plotUmax <- plot_summs(umax, robust = T, plot.distributions = TRUE, colors = '#3C5488')+
  theme_bw()+
  theme(legend.position = 'none')+
  theme(axis.ticks.length = unit(.25, "cm"))+
  theme(legend.text = element_text(size=12))+
  theme(axis.text = element_text(size = 14), axis.title.y = element_text(size = 14), axis.title.x = element_text(size = 14))+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  theme(strip.text.x = element_text(size = 14))+
  scale_y_discrete(labels = c('m79','m54','m41','m26','m23','m21','m19','m17','m13','m4'))+
  ylab("Clone ID")+
  scale_x_continuous(breaks = c(-0.05, -0.025, 0, 0.025), labels = c(-1.05, -1.025, 1, 1.025))+
  xlab("Relative change")+
  ggtitle("umax")+
  scale_color_manual(values = "grey25")
  
plotLag <- plot_summs(lag, robust = T, plot.distributions = TRUE, colors = '#3C5488')+
  theme_bw()+
  theme(legend.position = 'none')+
  theme(axis.ticks.length = unit(.25, "cm"))+
  theme(axis.text = element_text(size = 14), axis.title.y = element_text(size = 14), axis.title.x = element_text(size = 14))+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  theme(strip.text.x = element_text(size = 14))+
  scale_y_discrete(labels = c('m79','m54','m41','m26','m23','m21','m19','m17','m13','m4'))+
  ylab("Clone ID")+
  scale_x_continuous(breaks = c(-2, -1.5, -1, -0.5, 0), labels = c(-3, -2.5, -2, -1.5, 1))+
  xlab("Relative change")+
  ggtitle("lag")+
  scale_color_manual(values = "grey25")

(plotUmax+theme(axis.title.x=element_blank()))+
  
(plotK+theme(axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank()))+
  
(plotLag+theme(axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(), 
        axis.title.x=element_blank()))
```

## Stats - Canan - BAYESIAN 
```{r}
# Clones as fixed factors
# K
bayesdata <- treats_param
bayesdata$clone <- factor(bayesdata$clone, levels = c("ancestor", 
           "m4", "m13", "m79", "m17", "m19", "m21", "m41", "m54", "m23", "m26"))

get_prior(A ~ 0 + clone, data = bayesdata, family = gaussian())

prior1 <- prior(student_t(3, 0, 2.5), class = sigma)

m1K <- brm(A ~ clone, data = bayesdata,
          family = "gaussian", prior = prior1)
summary(m1K)
posterior_summary(m1K)

rr <- rope_range(m1K)
#-0.1 * sd(y), 0.1 * sd(y)
result1K <- describe_posterior(m1K, centrality = c("median", "mean"),
                          rope_ci = 0.95, 
                          ci = 0.95,
                          ci_method = "HDI", 
            test = c("equivalence_test", "p_direction", "p_significance"),
                          rope_range = rr, 
                          diagnostic = "Rhat")
result2K <- equivalence_test(m1K, 
                          rope_ci = 0.95, 
                          ci = 0.95,
                          ci_method = "HDI", 
                          rope_range = rr,
                          sort = NULL)
plot(result2K)

# umax
m1umax <- brm(umax ~ clone, data = bayesdata,
          family = "gaussian", prior = prior1)
summary(m1umax)
posterior_summary(m1umax)

rr2 <- rope_range(m1umax)
result1umax <- describe_posterior(m1umax, centrality = c("median", "mean"),
                          rope_ci = 0.95, 
                          ci = 0.95,
                          ci_method = "HDI", 
                test = c("equivalence_test", "p_direction", "p_significance"),
                          rope_range = rr2, 
                          diagnostic = "Rhat")
result2umax <- equivalence_test(m1umax, 
                          rope_ci = 0.95, 
                          ci = 0.95,
                          ci_method = "HDI", 
                          rope_range = rr2)
plot(result2umax)

# L
m1L <- brm(L ~ clone, data = bayesdata,
          family = "gaussian", prior = prior1)
summary(m1L)
posterior_summary(m1L)

rr3 <- rope_range(m1L)
result1L <- describe_posterior(m1L, centrality = c("median", "mean"),
                          rope_ci = 0.95, 
                          ci = 0.95,
                          ci_method = "HDI", 
                    test = c("equivalence_test", "p_direction", "p_significance"),
                          rope_range = rr3, 
                          diagnostic = "Rhat")
result2L <- equivalence_test(m1L, 
                          rope_ci = 0.95, 
                          ci = 0.95,
                          ci_method = "HDI", 
                          rope_range = rr3)
plot(result2L)


#Mutatios as fixed, clones as random factors

get_prior(umax ~ 0 + mutation + (1|clone), data = bayesdata, family = gaussian())

prior2 <- c(prior(student_t(3, 0, 2.5), class = sigma), 
            prior(student_t(3, 0, 2.5), class = sd))

m2K <- brm(A ~ mutation + (1|clone), data = bayesdata,
          family = "gaussian", prior = prior2)
summary(m2K)
posterior_summary(m2K)

rrR <- rope_range(m2K)
#-0.1 * sd(y), 0.1 * sd(y)
result2KR <- describe_posterior(m2K, centrality = c("median", "mean"),
                          rope_ci = 0.95, 
                          ci = 0.95,
                          ci_method = "HDI", 
            test = c("equivalence_test", "p_direction", "p_significance"),
                          rope_range = rrR, 
                          diagnostic = "Rhat")
result2KR <- equivalence_test(m2K, 
                          rope_ci = 0.95, 
                          ci = 0.95,
                          ci_method = "HDI", 
                          rope_range = rrR, 
                          effects = "all")
plot(result2KR)

# umax
m2umax <- brm(umax ~ mutation + (1|clone), data = bayesdata,
          family = "gaussian", prior = prior2)
summary(m2umax)
posterior_summary(m2umax)

rr3 <- rope_range(m2umax)
result1umaxR <- describe_posterior(m2umax, centrality = c("median", "mean"),
                          rope_ci = 0.95, 
                          ci = 0.95,
                          ci_method = "HDI", 
                test = c("equivalence_test", "p_direction", "p_significance"),
                          rope_range = rr3, 
                          diagnostic = "Rhat")
result2umaxR <- equivalence_test(m2umax, 
                          rope_ci = 0.95, 
                          ci = 0.95,
                          ci_method = "HDI", 
                          rope_range = rr3,
                          effects = "all")
plot(result2umaxR)

# L
m2L <- brm(L ~ mutation + (1|clone), data = bayesdata,
          family = "gaussian", prior = prior2)
summary(m2L)
posterior_summary(m2L)

rr4 <- rope_range(m2L)
result2LR <- describe_posterior(m2L, centrality = c("median", "mean"),
                          rope_ci = 0.95, 
                          ci = 0.95,
                          ci_method = "HDI", 
                    test = c("equivalence_test", "p_direction", "p_significance"),
                          rope_range = rr4, 
                          diagnostic = "Rhat")
result2LR <- equivalence_test(m2L, 
                          rope_ci = 0.95, 
                          ci = 0.95,
                          ci_method = "HDI", 
                          rope_range = rr4, 
                          effects = "all")
plot(result2LR)
```

## Stats - Custom plots BAYESIAN - Canan
```{r}
theme <-  theme_bw()+
  theme(legend.position = 'none')+
  theme(axis.ticks.length = unit(.25, "cm"))+
  theme(legend.text = element_text(size=12))+
  theme(axis.text = element_text(size = 14), axis.title.y = element_text(size = 14), axis.title.x = element_text(size = 14))+
  #theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  theme(strip.text.x = element_text(size = 14))

color_scheme_set("blue")

pars <- c("b_clonem26", "b_clonem23", "b_clonem54", "b_clonem41", "b_clonem21", "b_clonem19", "b_clonem17", "b_clonem79", "b_clonem13", "b_clonem4")

#labels are messed up
#labels <- c("m4", "m13", "m79", "m17", "m19", "m21", "m41", "m54", "m23", "m26")

posteriorK1 <- as.array(m1K)
posteriorumax1 <- as.array(m1umax)
posteriorL1 <- as.array(m1L)

#K
K1 <- mcmc_areas(posteriorK1, pars = pars,
  prob = 0.95, # 95% intervals
  prob_outer = 1)+
  geom_vline(xintercept = rope_range(m1K), linetype = "dashed", color = "grey25")+
  annotate("rect", xmin = rope_range(m1K)[1], xmax = rope_range(m1K)[2], ymin = -Inf, ymax = Inf,
           alpha = .2,fill = "grey")+
  #scale_y_discrete(labels = labels)+
  scale_x_continuous(breaks = c(-0.1, 0, 0.1), labels = c(-1.1, 1, 1.1))+
  xlab("Relative change")+
 ggtitle("K - posterior distributions",
"medians and 95% credible intervals(CI)")+
  theme
ggsave("K-clones.pdf", K1, height = 5, width = 5)

#umax
umax1 <- mcmc_areas(posteriorumax1, pars = pars,
  prob = 0.95, # 95% intervals
  prob_outer = 1)+
  geom_vline(xintercept = rope_range(m1umax), linetype = "dashed", color = "grey25")+
  annotate("rect", xmin = rope_range(m1umax)[1], xmax = rope_range(m1umax)[2], ymin = -Inf, ymax = Inf,
           alpha = .2,fill = "grey")+
  #scale_y_discrete(labels = labels)+
  #scale_x_continuous(breaks = c(-0.05, 0.1, 0, 0.05, 0.1), labels = c(-1.05, 1.1, 1, 1.05, 1.1))+
  xlab("Relative fitness")+
  ggtitle("µmax-posterior distributions",
"medians and 95% credible intervals (CI)")+
theme
ggsave("umax-clones.pdf", umax1, height = 5, width = 5)

#umax intervals
umax1 <- mcmc_intervals(posteriorumax1, pars = pars,
  prob = 0.95, # 95% intervals
  prob_outer = 1)+
  geom_vline(xintercept = rope_range(m1umax), linetype = "dashed", color = "grey25")+
  annotate("rect", xmin = rope_range(m1umax)[1], xmax = rope_range(m1umax)[2], ymin = -Inf, ymax = Inf,
           alpha = .2,fill = "grey")+
  #scale_y_discrete(labels = labels)+
  #scale_x_continuous(breaks = c(-0.05, 0.1, 0, 0.05, 0.1), labels = c(-1.05, 1.1, 1, 1.05, 1.1))+
  xlab("Relative fitness")+
  ggtitle("µmax-posterior distributions",
"medians and 95% credible intervals (CI)")+
theme
ggsave("umax-clones.pdf", umax1, height = 5, width = 5)

#L
lag1 <- mcmc_areas(posteriorL1, pars = pars,
  prob = 0.95, # 95% intervals
  prob_outer = 1)+
  geom_vline(xintercept = rope_range(m1L), linetype = "dashed", color = "grey25")+
  annotate("rect", xmin = rope_range(m1L)[1], xmax = rope_range(m1L)[2], ymin = -Inf, ymax = Inf,
           alpha = .2,fill = "grey")+
  #scale_y_discrete(labels = labels)+
  scale_x_continuous(breaks = c(-3, -2, -1, 0, 1), labels = c(-4, -3, -2, 1, 2))+
  xlab("Relative change")+
  ggtitle("lag - posterior distributions",
"medians and 95% credible intervals (CI)")+theme
ggsave("lag-clones.pdf", lag1, height = 5, width = 5)
```
## Bayesian Random effect plots - Canan
```{r}
posteriorK2 <- as.array(m2K)
posteriorumax2 <- as.array(m2umax)
posteriorL2 <- as.array(m2L)

pars_random <- c("r_clone[m4,Intercept]", "r_clone[m13,Intercept]", "r_clone[m79,Intercept]", 
                 "r_clone[m17,Intercept]", "r_clone[m19,Intercept]", "r_clone[m21,Intercept]", 
                 "r_clone[m41,Intercept]", "r_clone[m54,Intercept]", "r_clone[m23,Intercept]",
                 "r_clone[m26,Intercept]")

pars_fixed  <- rev(c("b_mutation3","b_mutation2","b_mutation4"))

fixed_labels <- rev(c("spore", "sinR","ywcC/slrR"))
random_labels <- rev(c('m26','m23','m54','m41','m21','m19','m17','m79','m13','m4'))

#K - random

K2_random <- mcmc_areas(posteriorK2, pars = pars_random,
  prob = 0.95, # 95% intervals
  prob_outer = 1)+
  geom_vline(xintercept = rope_range(m2K), linetype = "dashed", color = "grey25")+
  annotate("rect", xmin = rope_range(m2K)[1], xmax = rope_range(m2K)[2], ymin = -Inf, ymax = Inf,
           alpha = .2,fill = "grey")+
  scale_y_discrete(labels = random_labels)+
  xlab("Estimate")+
  ggtitle("K - random effects")+theme
ggsave("K-mutation-random.pdf", K2_random , height = 5, width = 5)

# K - fixed
K2_fixed <- mcmc_areas(posteriorK2, pars = pars_fixed,
  prob = 0.95, # 95% intervals
  prob_outer = 1)+
  geom_vline(xintercept = rope_range(m2K), linetype = "dashed", color = "grey25")+
  annotate("rect", xmin = rope_range(m2K)[1], xmax = rope_range(m2K)[2], ymin = -Inf, ymax = Inf,
           alpha = .2,fill = "grey")+
  scale_y_discrete(labels = fixed_labels)+
  scale_x_continuous(breaks = c(-0.2, 0, 0.2), labels = c(-1.2, 2, 1.2))+
  xlab("Relative change")+
  ggtitle("K - fixed effects")+theme
ggsave("K-mutation-fixed.pdf", K2_fixed , height = 5, width = 5)

# umax - random
umax2_random <- mcmc_areas(posteriorumax2, pars = pars_random,
  prob = 0.95, # 95% intervals
  prob_outer = 1)+
  geom_vline(xintercept = rope_range(m2umax), linetype = "dashed", color = "grey25")+
  annotate("rect", xmin = rope_range(m2umax)[1] , xmax = rope_range(m2umax)[2] , ymin = -Inf, ymax = Inf,
           alpha = .2,fill = "grey")+
  scale_y_discrete(labels = random_labels)+
  xlab("Relative fitness")+
  ggtitle("µmax - random effects")+theme
ggsave("umax-mutation-random.pdf", umax2_random , height = 5, width = 5)

# mumax - fixed
umax2_fixed <- mcmc_areas(posteriorumax2, pars = pars_fixed,
  prob = 0.95, # 95% intervals
  prob_outer = 1)+
  geom_vline(xintercept = rope_range(m2umax), linetype = "dashed", color = "grey25")+
  annotate("rect", xmin = rope_range(m2umax)[1], xmax = rope_range(m2umax)[2], ymin = -Inf, ymax = Inf,
           alpha = .2,fill = "grey")+
  scale_y_discrete(labels = fixed_labels)+
  scale_x_continuous(breaks = c(-0.2, -0.1, 0, 0.1, 0.2), labels = c(-1.2, -1.1, 1, 1.1, 1.2))+
  xlab("Relative fitness")+
  ggtitle("µmax - fixed effects")+theme
ggsave("umax-mutation-fixed.pdf", umax2_fixed , height = 5, width = 5)

# L - random
lag2_random <- mcmc_areas(posteriorL2, pars = pars_random,
  prob = 0.95, # 95% intervals
  prob_outer = 1)+
  geom_vline(xintercept = rope_range(m2L), linetype = "dashed", color = "grey25")+
  annotate("rect", xmin = rope_range(m2L)[1] , xmax = rope_range(m2L)[2], ymin = -Inf, ymax = Inf,
           alpha = .2,fill = "grey")+
  scale_y_discrete(labels = random_labels)+
  xlab("Relative change")+
  ggtitle("lag - random effects")+theme
ggsave("lag-mutation-random.pdf", lag2_random , height = 5, width = 5)

# L - fixed
lag2_fixed <- mcmc_areas(posteriorL2, pars = pars_fixed,
  prob = 0.95, # 95% intervals
  prob_outer = 1)+
  geom_vline(xintercept = rope_range(m2L), linetype = "dashed", color = "grey25")+
  annotate("rect", xmin = rope_range(m2L)[1], xmax = rope_range(m2L)[2], ymin = -Inf, ymax = Inf,
           alpha = .2,fill = "grey")+
  
  scale_y_discrete(labels = fixed_labels)+
  scale_x_continuous(breaks = c(-3, -2, -1, 0, 1), labels = c(-4, -3, -2, 1, 2))+
  xlab("Relative change")+
  ggtitle("lag - fixed effects")+theme
ggsave("lag-mutation-fixed.pdf", lag2_fixed , height = 5, width = 5)

```



#  OLDER
## Wrangle into treatments - Jay's 
```{r}
# Ancestor
#anc <- parms %>% filter(evo.type == "anc") # before measuring ancestor on 11 June 23
anc <- anc.parms %>% filter(evo.type == "anc")
anc.mean <- anc %>% summarize(mean_A = mean(A), mean_umax = mean(umax), 
            mean_L = mean(L))
anc.sem <- anc %>% summarize(sem_A = sem(A), sem_umax = sem(umax), 
            sem_L = sem(L))
anc.95LL <- anc %>% summarize(LL.95_A = LL.95(A), LL.95_umax = LL.95(umax), 
            LL.95_L = LL.95(L))
anc.95UL <- anc %>% summarize(UL.95_A = UL.95(A), UL.95_umax = UL.95(umax), 
            UL.95_L = UL.95(L))

# Evolved
  ## Spore fraction
m23 <- parms %>% filter(strain == "M23")
m23.mean <- m23 %>% summarize(mean_A = mean(A), mean_umax = mean(umax), 
            mean_L = mean(L))
m23.sem <- m23 %>% summarize(sem_A = sem(A), sem_umax = sem(umax), 
            sem_L = sem(L))
m23.95LL <- m23 %>% summarize(LL.95_A = LL.95(A), LL.95_umax = LL.95(umax), 
            LL.95_L = LL.95(L))
m23.95UL <- m23 %>% summarize(UL.95_A = UL.95(A), UL.95_umax = UL.95(umax), 
            UL.95_L = UL.95(L))

m26 <- parms %>% filter(strain == "M26")
m26.mean <- m26 %>% summarize(mean_A = mean(A), mean_umax = mean(umax), 
            mean_L = mean(L))
m26.sem <- m26 %>% summarize(sem_A = sem(A), sem_umax = sem(umax), 
            sem_L = sem(L))
m26.95LL <- m26 %>% summarize(LL.95_A = LL.95(A), LL.95_umax = LL.95(umax), 
            LL.95_L = LL.95(L))
m26.95UL <- m26 %>% summarize(UL.95_A = UL.95(A), UL.95_umax = UL.95(umax), 
            UL.95_L = UL.95(L))

  ## Total fraction
      ### sinR mutants
m17 <- parms %>% filter(strain == "M17")
m17.mean <- m17 %>% summarize(mean_A = mean(A), mean_umax = mean(umax), 
            mean_L = mean(L))
m17.sem <- m17 %>% summarize(sem_A = sem(A), sem_umax = sem(umax), 
            sem_L = sem(L))
m17.95LL <- m17 %>% summarize(LL.95_A = LL.95(A), LL.95_umax = LL.95(umax), 
            LL.95_L = LL.95(L))
m17.95UL <- m17 %>% summarize(UL.95_A = UL.95(A), UL.95_umax = UL.95(umax), 
            UL.95_L = UL.95(L))

m19 <- parms %>% filter(strain == "M19")
m19.mean <- m19 %>% summarize(mean_A = mean(A), mean_umax = mean(umax), 
            mean_L = mean(L))
m19.sem <- m19 %>% summarize(sem_A = sem(A), sem_umax = sem(umax), 
            sem_L = sem(L))
m19.95LL <- m19 %>% summarize(LL.95_A = LL.95(A), LL.95_umax = LL.95(umax), 
            LL.95_L = LL.95(L))
m19.95UL <- m19 %>% summarize(UL.95_A = UL.95(A), UL.95_umax = UL.95(umax), 
            UL.95_L = UL.95(L))

m21 <- parms %>% filter(strain == "M21")
m21.mean <- m21 %>% summarize(mean_A = mean(A), mean_umax = mean(umax), 
            mean_L = mean(L))
m21.sem <- m21 %>% summarize(sem_A = sem(A), sem_umax = sem(umax), 
            sem_L = sem(L))
m21.95LL <- m21 %>% summarize(LL.95_A = LL.95(A), LL.95_umax = LL.95(umax), 
            LL.95_L = LL.95(L))
m21.95UL <- m21 %>% summarize(UL.95_A = UL.95(A), UL.95_umax = UL.95(umax), 
            UL.95_L = UL.95(L))

m41 <- parms %>% filter(strain == "M41")
m41.mean <- m41 %>% summarize(mean_A = mean(A), mean_umax = mean(umax), 
            mean_L = mean(L))
m41.sem <- m41 %>% summarize(sem_A = sem(A), sem_umax = sem(umax), 
            sem_L = sem(L))
m41.95LL <- m41 %>% summarize(LL.95_A = LL.95(A), LL.95_umax = LL.95(umax), 
            LL.95_L = LL.95(L))
m41.95UL <- m41 %>% summarize(UL.95_A = UL.95(A), UL.95_umax = UL.95(umax), 
            UL.95_L = UL.95(L))

m54 <- parms %>% filter(strain == "M54")
m54.mean <- m54 %>% summarize(mean_A = mean(A), mean_umax = mean(umax), 
            mean_L = mean(L))
m54.sem <- m54 %>% summarize(sem_A = sem(A), sem_umax = sem(umax), 
            sem_L = sem(L))
m54.95LL <- m54 %>% summarize(LL.95_A = LL.95(A), LL.95_umax = LL.95(umax), 
            LL.95_L = LL.95(L))
m54.95UL <- m54 %>% summarize(UL.95_A = UL.95(A), UL.95_umax = UL.95(umax), 
            UL.95_L = UL.95(L))

      ### ywcC mutants
m4 <- parms %>% filter(strain == "M4")
m4.mean <- m4 %>% summarize(mean_A = mean(A), mean_umax = mean(umax), 
            mean_L = mean(L))
m4.sem <- m4 %>% summarize(sem_A = sem(A), sem_umax = sem(umax), 
            sem_L = sem(L))
m4.95LL <- m4 %>% summarize(LL.95_A = LL.95(A), LL.95_umax = LL.95(umax), 
            LL.95_L = LL.95(L))
m4.95UL <- m4 %>% summarize(UL.95_A = UL.95(A), UL.95_umax = UL.95(umax), 
            UL.95_L = UL.95(L))

m13 <- parms %>% filter(strain == "M13")
m13.mean <- m13 %>% summarize(mean_A = mean(A), mean_umax = mean(umax), 
            mean_L = mean(L))
m13.sem <- m13 %>% summarize(sem_A = sem(A), sem_umax = sem(umax), 
            sem_L = sem(L))
m13.95LL <- m13 %>% summarize(LL.95_A = LL.95(A), LL.95_umax = LL.95(umax), 
            LL.95_L = LL.95(L))
m13.95UL <- m13 %>% summarize(UL.95_A = UL.95(A), UL.95_umax = UL.95(umax), 
            UL.95_L = UL.95(L))

m79 <- parms %>% filter(strain == "M79")
m79.mean <- m79 %>% summarize(mean_A = mean(A), mean_umax = mean(umax), 
            mean_L = mean(L))
m79.sem <- m79 %>% summarize(sem_A = sem(A), sem_umax = sem(umax), 
            sem_L = sem(L))
m79.95LL <- m79 %>% summarize(LL.95_A = LL.95(A), LL.95_umax = LL.95(umax), 
            LL.95_L = LL.95(L))
m79.95UL <- m79 %>% summarize(UL.95_A = UL.95(A), UL.95_umax = UL.95(umax), 
            UL.95_L = UL.95(L))
```

## Make figure -Jay's
```{r}
# Create plot
png(filename="~/GitHub/SporeMut/output/4.GrowthCurves/growth.umaxNEW.png",
    width = 1200, height = 800, res = 96*2) 

plot.new()
par(mar = c(7, 7, 5, 7), plt = c(0.2, 0.85, 0.45, 0.85))

# Add individuals points
anc.pt <- plot(jitter(rep(1, length(anc$umax)), amount = 0.1), anc$umax, 
      ylim = c(0.02, 0.1), xlim = c(0.5, 15), pch = 21, col = "grey75", 
      bg = "grey75",
      cex = 1.7, yaxt = "n", xaxt = "n", cex.lab = 2, cex.axis = 1.5,
      las = 1, ylab = "", xlab = "")
      box(lwd = 2)

#lwd = 2 This doesn't work on my computer -CK
# Spore mutants
points(jitter(rep(3, length(m23$umax)), amount = 0.1), m23$umax, pch = 21, 
       bg = "grey75", col = "grey75", lwd = 2, cex = 1.7)
points(jitter(rep(4, length(m26$umax)), amount = 0.1), m26$umax, pch = 21, 
       bg = "grey75", col = "grey75", lwd = 2, cex = 1.7)

# Total mutants: sinR
points(jitter(rep(6, length(m17$umax)), amount = 0.1), m17$umax, pch = 21, 
       bg = "grey75", col = "grey75", lwd = 2, cex = 1.7)
points(jitter(rep(7, length(m19$umax)), amount = 0.1), m17$umax, pch = 21, 
       bg = "grey75", col = "grey75", lwd = 2, cex = 1.7)
points(jitter(rep(8, length(m21$umax)), amount = 0.1), m21$umax, pch = 21, 
       bg = "grey75", col = "grey75", lwd = 2, cex = 1.7)
points(jitter(rep(9, length(m41$umax)), amount = 0.1), m41$umax, pch = 21, 
       bg = "grey75", col = "grey75", lwd = 2, cex = 1.7)
points(jitter(rep(10, length(m54$umax)), amount = 0.1), m54$umax, pch = 21, 
       bg = "grey75", col = "grey75", lwd = 2, cex = 1.7)

# Total mutants: ywcC 
points(jitter(rep(12, length(m4$umax)), amount = 0.1), m4$umax, pch = 21, 
       bg = "grey75", col = "grey75", lwd = 2, cex = 1.7)
points(jitter(rep(13, length(m13$umax)), amount = 0.1), m13$umax, pch = 21, 
       bg = "grey75", col = "grey75", lwd = 2, cex = 1.7)
points(jitter(rep(14, length(m79$umax)), amount = 0.1), m79$umax,pch = 21, 
       bg = "grey75", col = "grey75", lwd = 2, cex = 1.7)

# Add means
points(1, anc.mean[2], pch = 21, col = "black", 
       bg = "NA", lwd = 2, cex = 2) 
points(3, m23.mean[2], pch = 21, col = "black", 
       bg = "NA", lwd = 2, cex = 2)  
points(4, m26.mean[2], pch = 21, col = "black", 
       bg = "NA", lwd = 2, cex = 2) 
points(6, m17.mean[2], pch = 21, col = "black", 
       bg = "NA", lwd = 2, cex = 2) 
points(7, m19.mean[2], pch = 21, col = "black", 
       bg = "NA", lwd = 2, cex = 2) 
points(8, m21.mean[2], pch = 21, col = "black", 
       bg = "NA", lwd = 2, cex = 2) 
points(9, m41.mean[2], pch = 21, col = "black", 
       bg = "NA", lwd = 2, cex = 2) 
points(10, m54.mean[2], pch = 21, col = "black", 
       bg = "NA", lwd = 2, cex = 2) 
points(12, m4.mean[2], pch = 21, col = "black", 
       bg = "NA", lwd = 2, cex = 2) 
points(13, m13.mean[2], pch = 21, col = "black", 
       bg = "NA", lwd = 2, cex = 2) 
points(14, m79.mean[2], pch = 21, col = "black", 
       bg = "NA", lwd = 2, cex = 2) 

arrows(x0 = c(1, 3, 4, 6, 7, 8, 9, 10, 12, 13, 14), y0 = as.numeric(c(anc.mean[2], m23.mean[2], 
      m26.mean[2], m17.mean[2], m19.mean[2], m21.mean[2], m41.mean[2], m54.mean[2], 
      m4.mean[2], m13.mean[2], m79.mean[2])), y1 = as.numeric(c(anc.95UL[2], m23.95UL[2], 
      m26.95UL[2], m17.95UL[2], m19.95UL[2], m21.95UL[2], m41.95UL[2], 
      m54.95UL[2], m4.95UL[2], m13.95UL[2], m79.95UL[2])), angle = 90, length = 0.1, lwd = 2)
       
arrows(x0 = c(1, 3, 4, 6, 7, 8, 9, 10, 12, 13, 14), y0 = as.numeric(c(anc.mean[2], m23.mean[2], 
      m26.mean[2], m17.mean[2], m19.mean[2], m21.mean[2], m41.mean[2], m54.mean[2], 
      m4.mean[2], m13.mean[2], m79.mean[2])), y1 = as.numeric(c(anc.95LL[2], m23.95LL[2], 
      m26.95LL[2], m17.95LL[2], m19.95LL[2], m21.95LL[2], m41.95LL[2], 
      m54.95LL[2], m4.95LL[2], m13.95LL[2], m79.95LL[2])), angle = 90, length = 0.1, lwd = 2)

# Add axes
axis(side = 2, lwd.ticks = 2, cex.axis = 1.25, las = 1,
     labels = c("0.025", "0.050", "0.075", "0.100"), at = c(0.025, 0.05, 0.075, 0.100))

axis(side = 4, lwd.ticks = 2, cex.axis = 1.25, las = 1,
     at=c(0.025, 0.05, 0.075, 0.100), labels = F)

axis(side = 3, lwd.ticks = 2, cex.axis = 1, las = 1,
     at = c(1, 3, 4, 6, 7, 8, 9, 10, 12, 13, 14), labels = F)

axis(side = 1, lwd.ticks = 2, cex.axis = 1, las = 3,
     labels = c("anc", "m23", "m26", "m17", "m19", "m21", "m41", "m54", "m4",
    "m13", "m79"), at = c(1, 3, 4, 6, 7, 8, 9, 10, 12, 13, 14), col.axis = "grey80")

# Add y-axis label
mtext(expression('Maximum growth rate (d'^-1*')'), side = 2,
      outer = FALSE, cex = 1.25, line = 4.5, adj = 0.5)

# Add x-axis labels
mtext('Ancestor', side = 1, line = 6.25, at = 1, cex = 0.95, col = "grey80")
segments(0.25, -0.047, 1.75, -0.047, col = "grey80", lwd = 2, xpd = TRUE)

mtext('Evolved', side = 1, line = 6.25, at = 8.5, cex = 0.95, col = "grey80")
segments(2.75, -0.047, 14.25, -0.047, col = "grey80", lwd = 2, xpd = TRUE)

mtext('Spore', side = 1, line = 4.5, at = 3.5, cex = 0.95, col = "grey80")
segments(2.75, -0.03, 4.25, -0.03, col = "grey80", lwd = 2, xpd = TRUE)

mtext('Total', side = 1, line = 4.5, at = 10.5, cex = 0.95, col = "grey80")
segments(5.75, -0.03, 14.25, -0.03, col = "grey80", lwd = 2, xpd = TRUE)

mtext(expression(italic("sinR")), side = 1, line = 2.95, at = 8, cex = 0.95, col = "grey80")
segments(5.75, -0.013, 10.25, -0.013, col = "grey80", lwd = 2, xpd = TRUE)

mtext(expression(italic("ywcC")), side = 1, line = 2.95, at = 13, cex = 0.95, col = "grey80")
segments(11.75, -0.013, 14.25, -0.013, col = "grey80", lwd = 2, xpd = TRUE)

# Close Plot Device
dev.off()
graphics.off()

# Show Plot
img <- readPNG("~/GitHub/SporeMut/output/4.GrowthCurves/growth.umax.png")

grid.raster(img)

```